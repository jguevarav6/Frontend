<app-page-layout title="Panel Principal">
<div class="items-list-page">
  <app-dashboard-main>

      <!-- === TRES TARJETAS EN FILA (responsive) === -->
      <div class="summary-cards">
        <!-- Card 1 -->
        <div class="summary-card">
          <div class="absolute -top-3 -right-3 size-20 bg-green-100 dark:bg-green-900/30 rounded-full" aria-hidden="true"></div>
          <div class="relative z-10">
            <div class="flex items-center gap-4">
              <span class="inline-block size-10 rounded-full bg-[#26a269]" aria-hidden="true"></span>
              <p class="text-base font-semibold text-gray-700 dark:text-gray-300">Declaraciones</p>
            </div>
            <p class="mt-4 text-4xl font-bold text-[#1f7a46]">Al día</p>
            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">¡Excelente trabajo!</p>
          </div>
        </div>

        <!-- Card 2 -->
        <div class="summary-card">
          <div class="absolute -top-3 -right-3 size-20 bg-blue-100 dark:bg-blue-900/30 rounded-full" aria-hidden="true"></div>
          <div class="relative z-10">
            <div class="flex items-center gap-4">
              <span class="inline-block size-10 rounded-full bg-[#2f6df6]" aria-hidden="true"></span>
              <p class="text-base font-semibold text-gray-700 dark:text-gray-300">Pagos Pendientes</p>
            </div>
            <p class="mt-4 text-4xl font-bold text-[#2f6df6] dark:text-secondary">COP 0</p>
            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">No tienes saldos por pagar.</p>
          </div>
        </div>

        <!-- Card 3 (CTA) -->
        <div class="summary-card cta">
          <div>
            <h3 class="text-2xl font-bold">Nueva Declaración</h3>
            <p class="text-sm md:text-base opacity-90 mt-2">Inicia tu próxima declaración de impuestos aquí.</p>
          </div>
          <a [routerLink]="['/items','declaracion']"
             class="mt-4 self-start bg-[#FFC107] hover:brightness-110 text-[#08263A] font-semibold py-2 px-5 rounded-lg inline-flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-400">
            Empezar ahora
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M8 5l8 7-8 7" stroke="#08263A" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </a>
        </div>
      </div>

      <!-- === RIGHT RAIL (Impuestos Pagados) === -->
      <div class="right-rail lg:col-span-2">
        <app-taxes-paid></app-taxes-paid>
      </div>

      <!-- === ITEMS DINÁMICOS === -->
      <section class="documents mt-12 lg:col-span-3">
        <!-- Search + toolbar -->
        <div class="mb-4 space-y-3">
          <div class="flex items-center justify-between gap-4">
            <div class="relative flex-1 max-w-xl">
              <svg class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
              </svg>
              <input
                type="search"
                [value]="query"
                (input)="onQueryChange($any($event.target).value)"
                placeholder="Buscar por título o id…"
                class="w-full h-10 rounded-xl pl-10 pr-3 border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all" />
            </div>
            <div class="flex gap-2 flex-wrap">
              <button class="px-4 py-2 text-sm font-medium border-2 rounded-lg bg-gradient-to-r from-blue-500 to-blue-600 text-white hover:from-blue-600 hover:to-blue-700 shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2"
                      (click)="refreshFromAPI()"
                      title="Recargar datos desde la API">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                </svg>
                <span>Refrescar API</span>
              </button>
              <ng-container *ngIf="items$ | async as fItems">
                <ng-container *ngIf="selectedIds$ | async as selIds">
                  <!-- Exportar CSV -->
                  <button class="px-3 py-2 text-sm font-medium border rounded-lg hover:bg-gray-50 transition-colors duration-200 flex items-center gap-2"
                          (click)="exportToCSV(fItems)"
                          [title]="selIds.length > 0 ? 'Exportar ' + selIds.length + ' elementos seleccionados a CSV' : 'Exportar todos los elementos a CSV'">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                    </svg>
                    <span class="hidden sm:inline">{{selIds.length > 0 ? 'CSV (' + selIds.length + ')' : 'CSV'}}</span>
                  </button>
                  
                  <!-- Exportar PDF -->
                  <button class="px-3 py-2 text-sm font-medium border rounded-lg bg-red-50 hover:bg-red-100 text-red-700 transition-colors duration-200 flex items-center gap-2"
                          (click)="exportToPDF(fItems)"
                          [title]="selIds.length > 0 ? 'Exportar ' + selIds.length + ' elementos seleccionados a PDF' : 'Exportar todos los elementos a PDF'">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                      <path d="M14 2v6h6M12 18v-6M9 15l3 3 3-3"/>
                    </svg>
                    <span class="hidden sm:inline">{{selIds.length > 0 ? 'PDF (' + selIds.length + ')' : 'PDF'}}</span>
                  </button>
                </ng-container>
              </ng-container>
            </div>
          </div>
          
          <!-- Toolbar de selección, favoritos y ordenamiento -->
          <div class="flex items-center justify-between gap-2 flex-wrap">
            <div class="flex items-center gap-2 flex-wrap">
              <button class="px-3 py-2 text-sm font-medium border rounded-lg hover:bg-blue-50 transition-colors duration-200 flex items-center gap-2"
                      (click)="selectAll()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <path d="M9 11l3 3L22 4"></path>
                </svg>
                <span>Seleccionar Todos</span>
              </button>
              <button class="px-3 py-2 text-sm font-medium border rounded-lg hover:bg-gray-50 transition-colors duration-200 flex items-center gap-2"
                      (click)="clearAllSelection()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                </svg>
                <span>Deseleccionar Todos</span>
              </button>
              <ng-container *ngIf="selectedIds$ | async as selIds">
                <button class="px-4 py-2 text-sm font-medium border-2 rounded-lg bg-gradient-to-r from-red-500 to-red-600 text-white hover:from-red-600 hover:to-red-700 shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        *ngIf="selIds.length > 0"
                        [disabled]="isAnyDeleting()"
                        (click)="deleteSelected(selIds)">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6"/>
                  </svg>
                  <span *ngIf="!isAnyDeleting()">Eliminar Seleccionados ({{selIds.length}})</span>
                  <span *ngIf="isAnyDeleting()">Eliminando...</span>
                </button>
                <span *ngIf="selIds.length > 0" class="text-sm font-medium text-blue-600 bg-blue-50 px-3 py-2 rounded-lg">
                  ✓ {{selIds.length}} seleccionados
                </span>
              </ng-container>
              
              <!-- Filtro de Favoritos -->
              <button class="px-3 py-2 text-sm font-medium border rounded-lg transition-colors duration-200 flex items-center gap-2"
                      [class.bg-yellow-100]="(showOnlyFavorites$ | async)"
                      [class.text-yellow-800]="(showOnlyFavorites$ | async)"
                      [class.border-yellow-300]="(showOnlyFavorites$ | async)"
                      [class.hover:bg-yellow-200]="(showOnlyFavorites$ | async)"
                      [class.hover:bg-gray-50]="!(showOnlyFavorites$ | async)"
                      (click)="toggleShowOnlyFavorites()">
                <svg width="16" height="16" viewBox="0 0 24 24" [attr.fill]="(showOnlyFavorites$ | async) ? 'currentColor' : 'none'" stroke="currentColor" stroke-width="2">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
                <span>{{ (showOnlyFavorites$ | async) ? 'Mostrando favoritos' : 'Solo favoritos' }}</span>
              </button>
            </div>
            
            <!-- Selector de Ordenamiento -->
            <div class="flex items-center gap-2">
              <label class="text-sm font-medium text-gray-700">Ordenar por:</label>
              <select class="px-3 py-2 text-sm border rounded-lg hover:bg-gray-50 transition-colors duration-200"
                      (change)="setSortBy($any($event.target).value.split(',')[0], $any($event.target).value.split(',')[1])"
                      [value]="((sortBy$ | async)?.field || 'id') + ',' + ((sortBy$ | async)?.direction || 'asc')">
                <option value="id,asc">ID (Ascendente)</option>
                <option value="id,desc">ID (Descendente)</option>
                <option value="title,asc">Título (A-Z)</option>
                <option value="title,desc">Título (Z-A)</option>
                <option value="date,desc">Más recientes</option>
                <option value="date,asc">Más antiguos</option>
              </select>
            </div>
          </div>

          <!-- Contadores -->
          <div class="flex items-center gap-2 flex-wrap">
            <ng-container *ngIf="selectedIds$ | async as selIds">
            </ng-container>
          </div>
        </div>

        <ul class="space-y-3">
          <ng-container *ngIf="(filteredItems$ | async) as items">
            <li *ngIf="items.length === 0 && !loading" class="text-center py-12 text-gray-500">
              <svg class="mx-auto h-12 w-12 text-gray-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
              </svg>
              <p class="text-lg font-medium">No hay elementos para mostrar</p>
              <p class="text-sm mt-1">Presiona "Refrescar API" para cargar datos</p>
            </li>
            <li *ngFor="let it of items; trackBy: trackById"
              class="p-3 border rounded flex items-start justify-between gap-3 hover:bg-gray-50 transition-colors">
            <div class="flex items-start gap-3 flex-1">
              <input type="checkbox"
                     [checked]="isSelected(it.id) | async"
                     (change)="toggleSelect(it.id)"
                     class="mt-1 w-4 h-4 cursor-pointer"
                     [attr.aria-label]="'Seleccionar '+it.id" />
              
              <!-- Botón de Favorito -->
              <button (click)="toggleFavorite(it.id)"
                      class="mt-1 p-1 rounded hover:bg-yellow-100 transition-colors"
                      [attr.aria-label]="it.isFavorite ? 'Quitar de favoritos' : 'Marcar como favorito'"
                      [title]="it.isFavorite ? 'Quitar de favoritos' : 'Marcar como favorito'">
                <svg width="20" height="20" viewBox="0 0 24 24" 
                     [attr.fill]="it.isFavorite ? '#FFC107' : 'none'" 
                     [attr.stroke]="it.isFavorite ? '#FFC107' : 'currentColor'" 
                     stroke-width="2"
                     class="transition-all duration-200"
                     [class.scale-110]="it.isFavorite">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
              </button>
              
              <div class="flex-1">
                <div *ngIf="editingId !== it.id">
                  <div class="font-semibold">{{ it.title }}</div>
                  <div class="text-sm text-slate-600">{{ it.body }}</div>
                </div>
                <div *ngIf="editingId === it.id" class="space-y-2">
                  <input [id]="'edit-title-' + it.id"
                         [(ngModel)]="editModel.title"
                         class="w-full rounded border px-3 py-2" />
                  <textarea [(ngModel)]="editModel.body"
                            rows="3"
                            class="w-full rounded border px-3 py-2"></textarea>
                </div>
              </div>
            </div>

            <div class="flex flex-col gap-2">
              <button *ngIf="editingId !== it.id"
                      class="px-3 py-1 text-sm border rounded"
                      (click)="startInlineEdit(it)">
                Editar
              </button>

              <div *ngIf="editingId === it.id" class="flex gap-2">
                <button class="px-3 py-1 text-sm border rounded"
                        (click)="saveInlineEdit()">
                  Guardar
                </button>
                <button class="px-3 py-1 text-sm border rounded"
                        (click)="cancelInlineEdit()">
                  Cancelar
                </button>
              </div>

              <ng-container *ngIf="pendingDeleteId !== it.id">
                <button class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        [disabled]="isItemDeleting(it.id)"
                        (click)="requestDelete(it.id)">
                  <span *ngIf="!isItemDeleting(it.id)">Eliminar</span>
                  <span *ngIf="isItemDeleting(it.id)">...</span>
                </button>
                
              </ng-container>

              <div *ngIf="pendingDeleteId === it.id" class="flex gap-2">
                <button class="px-3 py-1 text-sm bg-red-600 text-white rounded"
                        (click)="confirmPendingDelete()">
                  Confirmar
                </button>
                <button class="px-3 py-1 text-sm border rounded" (click)="cancelPendingDelete()">
                  Cancelar
                </button>
              </div>
            </div>
          </li>
          </ng-container>
        </ul>

        <div class="mt-6 flex justify-center">
          <button (click)="loadMore()"
                  *ngIf="hasMore && !loading"
                  [disabled]="loading"
                  class="px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 shadow-md hover:shadow-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 5v14M5 12l7 7 7-7"/>
            </svg>
            <span>Cargar más elementos</span>
          </button>
          <div *ngIf="loading" class="text-center py-4 text-gray-600">
            <svg class="animate-spin h-6 w-6 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2">Cargando...</p>
          </div>
        </div>
      </section>

    </app-dashboard-main>
</div>
</app-page-layout>
